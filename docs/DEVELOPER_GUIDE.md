# ğŸ‘¨â€ğŸ’» Developer Guide - Backend

> Complete guide for backend developers working on Unsugar.io API

---

## ğŸš€ Quick Start

### Prerequisites

- Node.js 20.x or higher
- npm 10.x or higher
- MongoDB Atlas account (or local MongoDB)
- Git

### Initial Setup

```bash
# Clone repository
git clone https://github.com/kshitijshah95/unsugar-io-api.git
cd unsugar-api

# Install dependencies
npm install

# Setup environment (generates JWT secrets)
node setup-env.js

# Update .env with your MongoDB URI and OAuth credentials
# Edit .env file

# Start development server
npm run dev
```

Server runs at: **http://localhost:3001**

---

## ğŸ“ Project Structure

```
unsugar-api/
â”œâ”€â”€ docs/                       # Documentation
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ models/                # Mongoose models
â”‚   â”‚   â”œâ”€â”€ User.js           # User + OAuth
â”‚   â”‚   â””â”€â”€ Blog.js           # Blog posts
â”‚   â”œâ”€â”€ routes/               # API routes
â”‚   â”‚   â”œâ”€â”€ auth.js           # Authentication
â”‚   â”‚   â””â”€â”€ blogs.js          # Blog CRUD
â”‚   â”œâ”€â”€ middleware/           # Custom middleware
â”‚   â”‚   â”œâ”€â”€ auth.js           # JWT verification
â”‚   â”‚   â”œâ”€â”€ rateLimiter.js    # Rate limiting
â”‚   â”‚   â”œâ”€â”€ errorHandler.js   # Global errors
â”‚   â”‚   â””â”€â”€ notFound.js       # 404 handler
â”‚   â”œâ”€â”€ config/               # Configuration
â”‚   â”‚   â”œâ”€â”€ passport.js       # OAuth strategies
â”‚   â”‚   â”œâ”€â”€ database.js       # MongoDB connection
â”‚   â”‚   â””â”€â”€ config.js         # Environment config
â”‚   â”œâ”€â”€ utils/                # Utilities
â”‚   â”‚   â”œâ”€â”€ jwt.js            # JWT utils
â”‚   â”‚   â””â”€â”€ sanitize.js       # Input sanitization
â”‚   â”œâ”€â”€ scripts/              # Setup/seed scripts
â”‚   â”‚   â””â”€â”€ seedBlogs.js      # Database seeding
â”‚   â”œâ”€â”€ app.js                # Express app setup
â”‚   â””â”€â”€ server.js             # Server entry point
â”œâ”€â”€ .env                      # Environment variables
â””â”€â”€ package.json              # Dependencies
```

---

## ğŸ› ï¸ Development Workflow

### 1. Start Dev Server

```bash
npm run dev
```

- Auto-restart on file changes (nodemon)
- Morgan logging enabled
- MongoDB connection established

### 2. Seed Database

```bash
npm run seed
```

Seeds blog data from `src/data/blogs.js`

### 3. Test API Endpoints

```bash
# Health check
curl http://localhost:3001/health

# Get all blogs
curl http://localhost:3001/api/v1/blogs

# Register user
curl -X POST http://localhost:3001/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123","name":"Test User"}'

# Login
curl -X POST http://localhost:3001/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123"}'
```

---

## ğŸ”§ Environment Variables

### Required Variables

```env
# Server
PORT=3001
NODE_ENV=development

# Database
MONGODB_URI=mongodb+srv://user:pass@cluster.mongodb.net/unsugar-blog

# JWT Secrets (auto-generated by setup-env.js)
JWT_ACCESS_SECRET=<generated>
JWT_REFRESH_SECRET=<generated>

# OAuth (optional for local dev)
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
GITHUB_CLIENT_ID=your-github-client-id
GITHUB_CLIENT_SECRET=your-github-client-secret

# URLs
FRONTEND_URL=http://localhost:5173
API_BASE_URL=http://localhost:3001
CORS_ORIGIN=http://localhost:5173
```

### Generate JWT Secrets

```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

Or use the setup script:

```bash
node setup-env.js
```

---

## ğŸ“ Coding Standards

### API Response Format

```javascript
// Success
{
  success: true,
  data: { ... },
  message: "Optional message"
}

// Error
{
  success: false,
  message: "Error message",
  errors: [ ... ] // Optional validation errors
}
```

### Error Handling

```javascript
// âœ… Good: Try-catch with proper error response
router.post('/register', async (req, res) => {
  try {
    const user = await User.create(req.body);
    res.status(201).json({
      success: true,
      user
    });
  } catch (error) {
    res.status(500).json({
      success: false,
      message: process.env.NODE_ENV === 'production' 
        ? 'Registration failed' 
        : error.message
    });
  }
});

// âŒ Bad: No error handling
router.post('/register', async (req, res) => {
  const user = await User.create(req.body);
  res.json(user);
});
```

### Input Validation

```javascript
// âœ… Good: Validate all inputs
const { body, validationResult } = require('express-validator');

router.post('/register',
  [
    body('email').isEmail().normalizeEmail(),
    body('password').isLength({ min: 8 }),
    body('name').trim().notEmpty()
  ],
  async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({
        success: false,
        errors: errors.array()
      });
    }
    // Process request
  }
);

// âŒ Bad: No validation
router.post('/register', async (req, res) => {
  const user = await User.create(req.body);
  res.json(user);
});
```

### Authentication Middleware

```javascript
// âœ… Good: Use middleware
const { authenticate, authorize } = require('../middleware/auth');

router.get('/profile', authenticate, async (req, res) => {
  res.json({ user: req.user });
});

router.delete('/users/:id', 
  authenticate, 
  authorize('admin'), 
  async (req, res) => {
    // Delete user
  }
);
```

---

## ğŸ—„ï¸ Database Operations

### Creating Documents

```javascript
// Single document
const blog = await Blog.create({
  title: 'New Blog',
  slug: 'new-blog',
  content: 'Content here'
});

// Multiple documents
const blogs = await Blog.insertMany([
  { title: 'Blog 1', ... },
  { title: 'Blog 2', ... }
]);
```

### Querying

```javascript
// Find all
const blogs = await Blog.find();

// Find with filter
const blogs = await Blog.find({ tags: 'JavaScript' });

// Find one
const blog = await Blog.findOne({ slug: 'my-blog' });

// Find by ID
const blog = await Blog.findById(id);

// With pagination
const blogs = await Blog.find()
  .skip((page - 1) * limit)
  .limit(limit)
  .sort({ publishedDate: -1 });

// Select specific fields
const blogs = await Blog.find().select('title slug excerpt');

// Lean (faster, plain objects)
const blogs = await Blog.find().lean();
```

### Updating

```javascript
// Update one
await Blog.findByIdAndUpdate(id, {
  title: 'Updated Title'
}, { new: true });  // Return updated doc

// Update many
await Blog.updateMany(
  { tags: 'Old Tag' },
  { $set: { tags: 'New Tag' } }
);
```

### Deleting

```javascript
// Delete one
await Blog.findByIdAndDelete(id);

// Delete many
await Blog.deleteMany({ status: 'draft' });
```

---

## ğŸ”’ Security Best Practices

### 1. Never Trust User Input

```javascript
// âœ… Validate and sanitize
const { body } = require('express-validator');

router.post('/blog',
  body('title').trim().escape(),
  async (req, res) => { ... }
);
```

### 2. Use Environment Variables

```javascript
// âœ… Good
const secret = process.env.JWT_SECRET;

// âŒ Bad
const secret = 'hardcoded-secret';
```

### 3. Hash Passwords

```javascript
// âœ… Handled by User model pre-save hook
userSchema.pre('save', async function(next) {
  if (this.isModified('password')) {
    this.password = await bcrypt.hash(this.password, 12);
  }
  next();
});
```

### 4. Rate Limit Endpoints

```javascript
const apiLimiter = require('../middleware/rateLimiter');
app.use('/api/', apiLimiter);
```

---

## ğŸ§ª Testing (Planned)

### Unit Tests

```bash
npm test
```

### API Tests

```bash
npm run test:api
```

---

## ğŸš¢ Deployment

### Render (Auto-Deploy)

1. Push to `main` branch
2. Render auto-builds and deploys
3. Live at: https://unsugar-io-api.onrender.com

### Environment Variables (Render)

Set in Render dashboard:

```env
NODE_ENV=production
MONGODB_URI=mongodb+srv://...
JWT_ACCESS_SECRET=<secret>
JWT_REFRESH_SECRET=<secret>
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
GITHUB_CLIENT_ID=...
GITHUB_CLIENT_SECRET=...
FRONTEND_URL=https://unsugar.io
API_BASE_URL=https://unsugar-io-api.onrender.com
CORS_ORIGIN=https://unsugar.io,https://unsugar-io.netlify.app
```

### Health Check

Render pings `/health` endpoint every 5 minutes

---

## ğŸ› Debugging

### Check MongoDB Connection

```javascript
// In server.js
const mongoose = require('mongoose');
console.log('MongoDB connection state:', mongoose.connection.readyState);
// 0 = disconnected, 1 = connected
```

### Enable Debug Logging

```javascript
// In .env
DEBUG=express:*,mongoose:*
```

### Check Request Logs

Morgan logs all HTTP requests:

```
GET /api/v1/blogs 200 123ms - 1234 bytes
POST /api/v1/auth/login 401 45ms - 89 bytes
```

---

## ğŸ“š Additional Resources

- **Architecture:** [docs/ARCHITECTURE.md](./ARCHITECTURE.md)
- **Backend Guide:** [docs/BACKEND.md](./BACKEND.md)
- **Database Guide:** [docs/DATABASE.md](./DATABASE.md)
- **Design Decisions:** [docs/DESIGN_DECISIONS_BACKEND.md](./DESIGN_DECISIONS_BACKEND.md)
- **SSO Guide:** [SSO_IMPLEMENTATION_COMPLETE.md](../SSO_IMPLEMENTATION_COMPLETE.md)

---

## ğŸ¤ Contributing

1. Create feature branch: `git checkout -b feature/new-feature`
2. Make changes
3. Test locally
4. Commit: `git commit -m "feat: add new feature"`
5. Push: `git push origin feature/new-feature`
6. Create Pull Request

### Commit Convention

- `feat:` New feature
- `fix:` Bug fix
- `docs:` Documentation
- `refactor:` Code restructure
- `test:` Tests
- `chore:` Maintenance

---

## ğŸ”— Links

- **Production API:** https://unsugar-io-api.onrender.com
- **Repository:** https://github.com/kshitijshah95/unsugar-io-api
- **Frontend:** https://unsugar.io
- **Frontend Repo:** https://github.com/kshitijshah95/unsugar-io
- **MongoDB Atlas:** https://cloud.mongodb.com
